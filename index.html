<script>
(function(){
  const title=document.getElementById('menuTitle');
  const main=document.getElementById('mainMenu');
  const menus={self:document.getElementById('menu-self')};
  let current='main',index=0;
  function currentList(){return current==='main'?main:menus[current];}
  function highlight(){
    const items=currentList().querySelectorAll('.menu-item');
    items.forEach((el,i)=>el.classList.toggle('selected',i===index));
  }
  function show(name){
    main.classList.add('hidden'); for(const k in menus)menus[k].classList.add('hidden');
    if(name==='main'){main.classList.remove('hidden');title.textContent='Control Panel';current='main';}
    else{menus[name].classList.remove('hidden');title.textContent=name.charAt(0).toUpperCase()+name.slice(1)+' Options';current=name;}
    index=0;highlight();
  }
  highlight();

  // Send to Lua (via Dui callback)
  function sendToLua(ev, data){
    if(window.SendDuiCallback)
      window.SendDuiCallback(ev, JSON.stringify(data||{}));
  }

  window.addEventListener('message', e=>{
    const data=e.data;
    if(!data || data.action!=='keydown') return;
    const list=currentList(); const items=list.querySelectorAll('.menu-item');
    if(!items.length)return;
    const key=data.key;

    if(key==='ArrowDown'){index=(index+1)%items.length;highlight();}
    else if(key==='ArrowUp'){index=(index-1+items.length)%items.length;highlight();}
    else if(key==='Enter'){
      const it=items[index]; if(!it)return;
      if(it.dataset.open){show(it.dataset.open);return;}
      if(it.dataset.type==='toggle'){
        const tog=it.querySelector('.toggle');
        const on=tog.classList.toggle('active');
        const name=it.textContent.trim().toLowerCase().split(" ")[0];
        sendToLua("menuAction",{option:name,enabled:on});
      }
    }
    else if(key==='Backspace'){
      if(current!=='main')show('main'); else sendToLua("close",{});
    }
  });
})();
</script>
